
## Support for mathematical formulas


### Requirements

Use the suggested TEI notation: `<formula id=f1 notation="TeX">$$E = mc^2$$</formula>` (see [TEI guidelines](http://www.tei-c.org/release/doc/tei-p5-doc/en/html/FT.html#FTFOR))

* Meet Project Gutenberg rules, that is convert to HTML and ePub without any dynamic content (that is, no javascript, no external fonts or dependencies on non-standard software, etc.)
* Look as good as normal (dynamic) MathJax output.
* Fully automated processing on command line (that is, it can be integrated in a build process)


### Implementation

The Project Gutenberg prohibition on active content make the direct use of MathJax impossible, so we need to follow a more complicated way to include mathematical formulas in text intended for PG.

The process consists of three steps:

1. Run XSLT to export all formulas into separate `.tex` files. This is done during normal processing.
2. Use the tool `convertFormulas.pl` to convert all these files to SVG files (and MathML).
3. Run XSLT again to include the generated SVG files as images (or inline) in the resulting file.

The resulting output files are placed in a folder `formulas`, and named according to the following naming scheme `(inline|display)-<ID>.tex`.

The script `convertFormulas.pl` will convert these files to files named `(inline|display)-<ID>.svg`. This script will use node.js with mathjax-node-cli to produce HTML, SVG, and MathML files from the exported formulas.


### Configuration

The following configuration options have been added:

* `math.mathJax.format` Determines the way mathJax is used to generate math. Possible values:
  * `MathJax`: use MathJax dynamically (loading javascript libraries)
  * `MML`: use inline MathML notation (generated by mathjax-node-cli)
  * `SVG`: use inline SVG (generated by mathjax-node-cli)
  * `SVG+IMG`: use SVG files, included using an HTML `img` tag.
* `math.mathJax.configuration` determines the MathJax configuration to use (only when the `MathJax` format is used).


### Installation of tools

1. install [Node.js](https://nodejs.org/en/). Make sure to install both node.js and npm.
2. install [Mathjax-node](https://github.com/mathjax/mathjax-node) using `npm install -g mathjax-node`.
3. install [Mathjax-node-cli](https://github.com/mathjax/mathjax-node-cli) using `npm install -g mathjax-node-cli`.


### Implementation details

The baseline is stored in the SVG files generated by MathJax. They can be read from the SVG file, using Xpath `/svg/@style`, and then parsing for the CSS value `vertical-align`.

The spoken version is also encoded in the MathJax generated SVG file, using Xpath, `/svg/title`.

Some articles about finding the baseline:

1. https://tex.stackexchange.com/questions/44486/pixel-perfect-vertical-alignment-of-image-rendered-tex-snippets/45621
2. https://www.princexml.com/forum/topic/2971/using-mathjax-with-princexml
